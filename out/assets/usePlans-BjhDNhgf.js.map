{"version":3,"file":"usePlans-BjhDNhgf.js","sources":["../../src/hooks/usePlans.ts"],"sourcesContent":["\nimport { useState, useEffect } from 'react';\n\ninterface Plan {\n  id: string;\n  name: string;\n  price: number;\n  features: string[];\n  active: boolean;\n}\n\ninterface TrialInfo {\n  isActive: boolean;\n  daysLeft: number;\n  hoursLeft: number;\n  minutesLeft: number;\n  startDate: Date;\n  endDate: Date;\n  hasExpired: boolean;\n}\n\nexport function usePlans() {\n  const [currentPlan, setCurrentPlan] = useState<Plan | null>(null);\n  const [trialInfo, setTrialInfo] = useState<TrialInfo>({\n    isActive: true,\n    daysLeft: 15,\n    hoursLeft: 0,\n    minutesLeft: 0,\n    startDate: new Date(),\n    endDate: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000),\n    hasExpired: false\n  });\n\n  // Función para calcular el tiempo restante\n  const calculateTimeLeft = (endDate: Date) => {\n    const now = new Date();\n    const timeLeft = endDate.getTime() - now.getTime();\n    \n    if (timeLeft <= 0) {\n      return {\n        daysLeft: 0,\n        hoursLeft: 0,\n        minutesLeft: 0,\n        isActive: false,\n        hasExpired: true\n      };\n    }\n\n    const daysLeft = Math.floor(timeLeft / (1000 * 60 * 60 * 24));\n    const hoursLeft = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n    const minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));\n\n    return {\n      daysLeft,\n      hoursLeft,\n      minutesLeft,\n      isActive: timeLeft > 0,\n      hasExpired: false\n    };\n  };\n\n  // Inicializar o recuperar información del trial\n  useEffect(() => {\n    const initializeTrial = () => {\n      const savedTrialInfo = localStorage.getItem('contard_trial_info');\n      const savedPlan = localStorage.getItem('contard_current_plan');\n      \n      // Cargar plan actual si existe\n      if (savedPlan) {\n        try {\n          const plan = JSON.parse(savedPlan);\n          setCurrentPlan(plan);\n        } catch (error) {\n          console.error('Error parsing saved plan:', error);\n          localStorage.removeItem('contard_current_plan');\n        }\n      }\n\n      if (savedTrialInfo) {\n        try {\n          const parsed = JSON.parse(savedTrialInfo);\n          const endDate = new Date(parsed.endDate);\n          const startDate = new Date(parsed.startDate);\n          \n          // Validar que las fechas sean válidas\n          if (isNaN(endDate.getTime()) || isNaN(startDate.getTime())) {\n            throw new Error('Invalid dates');\n          }\n\n          const timeLeft = calculateTimeLeft(endDate);\n          \n          setTrialInfo({\n            startDate,\n            endDate,\n            ...timeLeft\n          });\n        } catch (error) {\n          console.error('Error parsing trial info:', error);\n          // Si hay error, iniciar nuevo trial\n          startNewTrial();\n        }\n      } else {\n        // Primera vez - iniciar trial\n        startNewTrial();\n      }\n    };\n\n    const startNewTrial = () => {\n      const startDate = new Date();\n      const endDate = new Date(Date.now() + 15 * 24 * 60 * 60 * 1000);\n      \n      const newTrialInfo = {\n        isActive: true,\n        daysLeft: 15,\n        hoursLeft: 0,\n        minutesLeft: 0,\n        startDate,\n        endDate,\n        hasExpired: false\n      };\n      \n      localStorage.setItem('contard_trial_info', JSON.stringify({\n        startDate: startDate.toISOString(),\n        endDate: endDate.toISOString()\n      }));\n      \n      setTrialInfo(newTrialInfo);\n    };\n\n    initializeTrial();\n  }, []);\n\n  // Actualizar contador cada minuto\n  useEffect(() => {\n    const updateTimer = () => {\n      if (trialInfo.endDate && !currentPlan?.active) {\n        const timeLeft = calculateTimeLeft(trialInfo.endDate);\n        \n        setTrialInfo(prev => ({\n          ...prev,\n          ...timeLeft\n        }));\n\n        // Si el trial expiró, limpiar cualquier acceso\n        if (timeLeft.hasExpired) {\n          localStorage.setItem('contard_trial_expired', 'true');\n        }\n      }\n    };\n\n    // Actualizar inmediatamente\n    updateTimer();\n\n    // Actualizar cada minuto\n    const interval = setInterval(updateTimer, 60000);\n\n    return () => clearInterval(interval);\n  }, [trialInfo.endDate, currentPlan?.active]);\n\n  const subscribeToPlan = async (planId: string) => {\n    try {\n      // Verificar que el trial no haya expirado antes de permitir suscripción\n      if (trialInfo.hasExpired && !currentPlan?.active) {\n        return { \n          success: false, \n          error: 'El período de prueba ha expirado. Debe completar el pago para continuar.' \n        };\n      }\n\n      console.log('Subscribing to plan:', planId);\n      \n      const plan: Plan = {\n        id: planId,\n        name: planId.toUpperCase(),\n        price: getPlanPrice(planId),\n        features: getPlanFeatures(planId),\n        active: true\n      };\n      \n      setCurrentPlan(plan);\n      \n      // Marcar trial como completado (no expirado, sino completado por suscripción)\n      setTrialInfo(prev => ({\n        ...prev,\n        isActive: false,\n        hasExpired: false\n      }));\n      \n      localStorage.setItem('contard_current_plan', JSON.stringify(plan));\n      localStorage.removeItem('contard_trial_expired');\n      \n      return { success: true };\n    } catch (error) {\n      console.error('Error subscribing to plan:', error);\n      return { success: false, error: 'Error al procesar la suscripción' };\n    }\n  };\n\n  const cancelSubscription = async () => {\n    try {\n      setCurrentPlan(null);\n      localStorage.removeItem('contard_current_plan');\n      \n      // NO iniciar nuevo trial automáticamente al cancelar\n      // El usuario debe contactar soporte o pagar nuevamente\n      setTrialInfo(prev => ({\n        ...prev,\n        isActive: false,\n        hasExpired: true,\n        daysLeft: 0,\n        hoursLeft: 0,\n        minutesLeft: 0\n      }));\n      \n      localStorage.setItem('contard_trial_expired', 'true');\n      \n      return { success: true };\n    } catch (error) {\n      console.error('Error canceling subscription:', error);\n      return { success: false, error: 'Error al cancelar la suscripción' };\n    }\n  };\n\n  const hasAccess = () => {\n    // Tiene acceso si tiene plan activo O si el trial está activo y no ha expirado\n    return (currentPlan?.active === true) || (trialInfo.isActive && !trialInfo.hasExpired);\n  };\n\n  const canSelectPlan = () => {\n    // Puede seleccionar plan si tiene plan activo O si el trial no ha expirado\n    return (currentPlan?.active === true) || !trialInfo.hasExpired;\n  };\n\n  const getTrialStatus = () => {\n    if (currentPlan?.active) {\n      return 'subscribed';\n    }\n    \n    if (trialInfo.hasExpired) {\n      return 'expired';\n    }\n    \n    if (trialInfo.daysLeft <= 3) {\n      return 'warning';\n    }\n    \n    return 'active';\n  };\n\n  const getPlanPrice = (planId: string): number => {\n    const prices: Record<string, number> = {\n      'pyme': 19.97,\n      'pro': 49.97,\n      'plus': 99.97,\n      'student': 49.97\n    };\n    return prices[planId] || 0;\n  };\n\n  const getPlanFeatures = (planId: string): string[] => {\n    const features: Record<string, string[]> = {\n      'pyme': [\n        'Una empresa', \n        'Facturación básica con NCF', \n        'Dashboard básico',\n        'Reportes DGII básicos', \n        'Inventario limitado (500 productos)',\n        '2 usuarios'\n      ],\n      'pro': [\n        '3 empresas', \n        'Contabilidad completa', \n        'Dashboard básico',\n        'Gestión bancaria básica', \n        'Inventario limitado (2,000 productos)',\n        'Nómina básica (10 empleados)',\n        '5 usuarios'\n      ],\n      'plus': [\n        'Empresas ilimitadas', \n        'Todas las funciones contables', \n        'Dashboard KPI avanzado',\n        'Inventario ilimitado',\n        'Nómina completa',\n        'Análisis financiero avanzado',\n        'Usuarios ilimitados'\n      ],\n      'student': [\n        'Empresas ilimitadas', \n        'Todas las funciones contables', \n        'Dashboard KPI avanzado',\n        'Inventario ilimitado',\n        'Nómina completa',\n        'Análisis financiero avanzado',\n        'Válido con ID estudiantil',\n        'Usuarios ilimitados'\n      ]\n    };\n    return features[planId] || [];\n  };\n\n  return {\n    currentPlan,\n    trialInfo,\n    subscribeToPlan,\n    cancelSubscription,\n    hasAccess,\n    canSelectPlan,\n    getTrialStatus\n  };\n}\n"],"names":["usePlans","currentPlan","setCurrentPlan","useState","trialInfo","setTrialInfo","calculateTimeLeft","endDate","now","timeLeft","daysLeft","hoursLeft","minutesLeft","useEffect","initializeTrial","savedTrialInfo","savedPlan","plan","error","parsed","startDate","startNewTrial","newTrialInfo","updateTimer","prev","interval","subscribeToPlan","planId","getPlanPrice","getPlanFeatures","cancelSubscription","hasAccess","canSelectPlan","getTrialStatus"],"mappings":"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"}